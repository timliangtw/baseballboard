<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ£’çƒæ£‹ V4: æŠ½å¡å°æ±ºç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- åŸºç¤è¨­å®š --- */
    :root {
      --bg-color: #2b2f3a;
      --panel-bg: #20232b;
      --accent-color: #f8b739;
      --vis-color: #d32f2f; /* é è¨­å®¢éšŠç´… */
      --home-color: #1976d2; /* é è¨­ä¸»éšŠè— */
      --field-grass: #3c6e47;
      --field-dirt: #8d6e63;
      --line-color: rgba(255, 255, 255, 0.8);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-color); color: #f5f5f5;
      display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
    }

    /* å…¨è¢å¹•è¦†è“‹å±¤ (ç”¨æ–¼é–‹å§‹ç•«é¢ã€åœ–é‘‘ã€è¨­å®š) */
    .overlay-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(30, 34, 45, 0.98);
      z-index: 100;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    .overlay-screen.hidden { opacity: 0; pointer-events: none; }

    .title-logo { font-size: 3rem; font-weight: 900; color: var(--accent-color); margin-bottom: 30px; text-shadow: 0 0 20px rgba(248,183,57,0.5); letter-spacing: 2px; }
    
    .menu-btn {
      width: 220px; padding: 15px; margin: 10px; border: 2px solid var(--accent-color);
      background: transparent; color: var(--accent-color); font-size: 1.2rem; font-weight: bold;
      cursor: pointer; border-radius: 50px; transition: all 0.2s;
    }
    .menu-btn:hover { background: var(--accent-color); color: #222; transform: scale(1.05); }
    .menu-btn.primary { background: var(--accent-color); color: #222; }

    /* è¨­å®šç•«é¢ */
    .setup-container { width: 90%; max-width: 600px; background: #252a36; padding: 20px; border-radius: 16px; text-align: center; }
    .color-picker-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: transform 0.2s; }
    .color-option.selected { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    
    .initiative-area { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; background: #1a1d26; padding: 15px; border-radius: 12px; }
    .player-setup-box { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .roll-num { font-size: 2rem; font-weight: bold; min-width: 60px; }

    /* åœ–é‘‘èˆ‡æŠ½å¡ç•«é¢ */
    .gallery-grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
      gap: 10px; width: 90%; max-width: 800px; max-height: 70vh; overflow-y: auto; padding: 10px;
    }
    .card-preview {
      background: #2c303a; border: 1px solid #444; border-radius: 8px; padding: 10px;
      display: flex; flex-direction: column; align-items: center; text-align: center;
    }
    .card-preview.atk { border-top: 4px solid var(--accent-color); }
    .card-preview.def { border-top: 4px solid #448aff; }
    
    /* éŠæˆ²ä¸»é«” */
    .game-wrapper {
      width: 100%; max-width: 1100px; height: 100vh; max-height: 800px;
      background: var(--panel-bg); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      padding: 12px; display: flex; flex-direction: column; gap: 10px;
      filter: blur(0); transition: filter 0.5s;
    }
    .game-wrapper.blur { filter: blur(10px); }

    /* é ‚éƒ¨è¨ˆåˆ†æ¿ */
    .scoreboard {
      display: grid; grid-template-columns: 1.5fr 3fr 1.2fr; gap: 10px; padding: 10px 15px;
      background: #000; border-radius: 10px; align-items: center; border: 2px solid #333;
    }
    .team-info { display: flex; align-items: center; gap: 10px; }
    .team-logo { 
      width: 40px; height: 40px; border-radius: 50%; background: #444; 
      display: grid; place-items: center; font-weight: bold; font-size: 0.9rem;
    }
    .vis-logo { background: var(--vis-color); color: white; }
    .home-logo { background: var(--home-color); color: white; }

    .score-grid { display: grid; grid-template-columns: 2.5em repeat(9, 1fr) 2em; gap: 2px; font-family: monospace; font-weight: bold; }
    .score-grid .cell { background: #222; color: #555; text-align: center; padding: 4px 0; font-size: 0.85rem; border-radius: 2px; }
    .score-grid .header { color: #888; font-size: 0.6rem; background: transparent; }
    .score-grid .total { color: var(--accent-color); font-size: 1rem; }
    .score-grid .active-score { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
    .score-grid .team-name { text-align: left; padding-left: 5px; color: #fff; }

    .status-panel { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; font-family: monospace; }
    .bso-row { display: flex; gap: 6px; align-items: center; font-size: 0.75rem; color: #aaa; }
    .lights { display: flex; gap: 3px; }
    .light { width: 8px; height: 8px; border-radius: 50%; background: #333; border: 1px solid #444; }
    .light.on-green { background: #00e676; box-shadow: 0 0 5px #00e676; }
    .light.on-yellow { background: #ffeb3b; box-shadow: 0 0 5px #ffeb3b; }
    .light.on-red { background: #ff1744; box-shadow: 0 0 5px #ff1744; }

    /* ä¸»å€åŸŸ */
    .main-area { flex: 1; display: grid; grid-template-columns: 1.6fr 1.4fr; gap: 12px; min-height: 0; }

    /* çƒå ´ */
    .field-container {
      background: #181b23; border-radius: 16px; padding: 10px; position: relative;
      display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .field {
      position: relative; width: 100%; max-width: 450px; aspect-ratio: 1/1;
      background: radial-gradient(circle at 50% 50%, var(--field-dirt) 22%, transparent 23%), linear-gradient(0deg, var(--field-grass) 50%, #2e5a36 50%);
      background-size: 100% 100%, 100% 30px;
      border-radius: 12px; border: 4px solid #1a2e1e;
    }
    .infield-diamond {
      position: absolute; top: 50%; left: 50%; width: 42%; height: 42%;
      border: 2px solid var(--line-color); transform: translate(-50%, -50%) rotate(-45deg);
      box-sizing: border-box; z-index: 5;
    }
    .base { position: absolute; width: 20px; height: 20px; background: #fff; transform: translate(0, 0); box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .base.second { top: -10px; left: -10px; } 
    .base.first  { top: -10px; right: -10px; }
    .base.home   { bottom: -10px; right: -10px; border-radius: 2px 2px 10px 2px; }
    .base.third  { bottom: -10px; left: -10px; }
    .mound { 
      position: absolute; top: 50%; left: 50%; width: 34px; height: 34px; 
      background: var(--field-dirt); border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.2); z-index: 4;
    }
    .runner-dot {
      position: absolute; width: 22px; height: 22px; 
      background: var(--vis-color); border: 2px solid #fff; border-radius: 50%;
      transform: translate(-50%, -50%) scale(0); transition: top 0.6s linear, left 0.6s linear;
      z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); top: 50%; left: 50%;
    }
    .runner-dot.active { transform: translate(-50%, -50%) scale(1); }
    .runner-dot.home-team { background: var(--home-color); }

    .baseball {
      position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.5); z-index: 20; top: 50%; left: 50%; opacity: 0; pointer-events: none;
    }
    .baseball.animate { opacity: 1; transition: top 0.4s ease-out, left 0.4s ease-out; }

    /* äº’å‹•å€ */
    .interaction-panel { display: flex; flex-direction: column; gap: 10px; }
    .battle-slots {
      display: flex; justify-content: center; align-items: center; gap: 10px;
      background: #1a1a1a; padding: 10px; border-radius: 12px; min-height: 110px;
    }
    .slot-box {
      width: 90px; height: 100px; border: 2px dashed #444; border-radius: 8px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.3s; position: relative; overflow: hidden;
    }
    .slot-box.filled { border-style: solid; background: #2a2a2a; border-color: #666; }
    .slot-box.atk-filled { border-color: var(--accent-color); background: rgba(248, 183, 57, 0.1); }
    .slot-box.def-filled { border-color: #448aff; background: rgba(68, 138, 255, 0.1); }
    .slot-icon { font-size: 2.5rem; margin-bottom: 5px; }
    .slot-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
    .slot-name { font-size: 0.8rem; font-weight: bold; text-align: center; line-height: 1.1; }

    .decks-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; min-height: 200px;}
    .deck-column { display: flex; flex-direction: column; gap: 6px; }
    .deck-header { font-size: 0.8rem; text-align: center; padding-bottom: 4px; border-bottom: 2px solid #333; margin-bottom: 4px; }
    
    .card {
      background: #2c303a; border-radius: 8px; padding: 8px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; border: 1px solid transparent;
      transition: transform 0.1s, background 0.2s; position: relative;
    }
    .card:hover { background: #353a45; transform: translateY(-2px); }
    .card.selected { border-color: #fff; background: #444; }
    .card.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    .card.used::after { content: 'å·²ä½¿ç”¨'; position: absolute; inset:0; background:rgba(0,0,0,0.7); display:grid; place-items:center; color:#fff; font-size:0.8rem; border-radius:8px;}
    .card-icon { font-size: 1.8rem; width: 35px; text-align: center; }
    .card-info { flex: 1; }
    .card-title { font-size: 0.85rem; font-weight: bold; color: #eee; }
    .card-effect { font-size: 0.6rem; color: #aaa; }

    .controls {
      background: #252a36; padding: 10px; border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .dice-display { display: flex; gap: 15px; margin-bottom: 5px; }
    .die {
      width: 48px; height: 48px; background: #eee; border-radius: 8px; color: #222;
      font-size: 1.6rem; font-weight: 800; display: grid; place-items: center; box-shadow: 0 4px 0 #bbb;
    }
    .die.rolling { animation: shake 0.2s infinite; background: #ddd; }
    .status-text { text-align: center; height: 2.5em; display: flex; flex-direction: column; justify-content: center; }
    .main-status { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .sub-status { font-size: 0.8rem; color: var(--accent-color); }
    .play-btn {
      width: 100%; padding: 12px; border-radius: 50px; border: none;
      background: linear-gradient(135deg, var(--accent-color), #e6a320);
      font-size: 1.1rem; font-weight: bold; color: #222; cursor: pointer;
      box-shadow: 0 4px 10px rgba(248, 183, 57, 0.4); transition: transform 0.1s;
    }
    .play-btn:active { transform: scale(0.98); }
    .play-btn:disabled { background: #555; color: #888; box-shadow: none; }

    @keyframes shake { 0% {transform:rotate(5deg);} 50% {transform:rotate(-5deg);} 100% {transform:rotate(5deg);} }
  </style>
</head>
<body>

<!-- 0. æ¨™é¡Œèˆ‡é¸å–®ç•«é¢ -->
<div id="start-screen" class="overlay-screen">
  <div class="title-logo">BASEBALL BATTLE</div>
  <button class="menu-btn primary" onclick="goToSetup()">é–‹å§‹å°æˆ°</button>
  <button class="menu-btn" onclick="showGallery()">å¡ç‰Œåœ–é‘‘ (20ç¨®)</button>
</div>

<!-- 1. å¡ç‰Œåœ–é‘‘ (Modal) -->
<div id="gallery-screen" class="overlay-screen hidden">
  <div style="display:flex; justify-content:space-between; width:90%; max-width:800px; margin-bottom:10px;">
    <h2 style="color:var(--accent-color);">å¡ç‰Œåœ–é‘‘</h2>
    <button class="menu-btn" style="width:100px; padding:5px; font-size:1rem;" onclick="closeGallery()">è¿”å›</button>
  </div>
  <div class="gallery-grid" id="gallery-content">
    <!-- JS render cards here -->
  </div>
</div>

<!-- 2. è¨­å®šç•«é¢ (é¡è‰² & å…ˆå¾Œæ”» & æŠ½å¡) -->
<div id="setup-screen" class="overlay-screen hidden">
  <div class="setup-container">
    <h2 style="margin-bottom:20px;">è³½å‰æº–å‚™</h2>
    
    <!-- æ­¥é©Ÿ 1: é¸é¡è‰² -->
    <div id="step-color">
      <div style="display:flex; justify-content:space-between;">
        <div style="text-align:center;">
          <div>P1 (å®¢éšŠ)</div>
          <div class="color-picker-row" id="p1-colors">
            <!-- JS render colors -->
          </div>
        </div>
        <div style="width:2px; background:#444;"></div>
        <div style="text-align:center;">
          <div>P2 (ä¸»éšŠ)</div>
          <div class="color-picker-row" id="p2-colors">
            <!-- JS render colors -->
          </div>
        </div>
      </div>
      <button class="menu-btn primary" onclick="goToInitiative()">ç¢ºèªé¡è‰²</button>
    </div>

    <!-- æ­¥é©Ÿ 2: æ±ºå®šå…ˆå¾Œæ”» -->
    <div id="step-initiative" style="display:none;">
      <h3>æ¯”å¤§å°æ±ºå®šä¸»å®¢å ´</h3>
      <p style="font-size:0.8rem; color:#aaa;">æ•¸å­—å¤§è€…ç‚ºä¸»éšŠ(å¾Œæ”»)</p>
      <div class="initiative-area">
        <div class="player-setup-box">
          <div>P1</div>
          <div class="roll-num" id="p1-roll">-</div>
          <button class="menu-btn" style="width:80px; font-size:0.8rem;" id="btn-roll-p1" onclick="rollInitiative(1)">ROLL</button>
        </div>
        <div style="font-size:1.5rem; font-weight:bold;">VS</div>
        <div class="player-setup-box">
          <div>P2</div>
          <div class="roll-num" id="p2-roll">-</div>
          <button class="menu-btn" style="width:80px; font-size:0.8rem;" id="btn-roll-p2" onclick="rollInitiative(2)">ROLL</button>
        </div>
      </div>
      <div id="initiative-result" style="height:30px; color:var(--accent-color); font-weight:bold;"></div>
      <button class="menu-btn primary" id="btn-go-draw" style="display:none;" onclick="goToDraw()">å‰å¾€æŠ½å¡</button>
    </div>

    <!-- æ­¥é©Ÿ 3: æŠ½å¡ -->
    <div id="step-draw" style="display:none;">
      <h3>æŠ½å–æœ¬å ´ç‰¹æ®Šå¡ (å„3å¼µ)</h3>
      <div style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
         <div class="card-preview" style="width:120px; height:160px; justify-content:center; cursor:pointer; background:#444;" onclick="drawCardsAnimation()">
           <div style="font-size:3rem;">ğŸ</div>
           <div>é»æ“ŠæŠ½å¡</div>
         </div>
      </div>
      <div id="draw-result-area" style="display:none;">
         <div style="font-size:0.9rem; margin-bottom:10px;">å·²ç²å¾—å¡ç‰Œï¼š</div>
         <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left;">
            <div>
               <div style="color:#d32f2f; font-size:0.8rem;">å®¢éšŠæ‰‹ç‰Œ</div>
               <div id="vis-hand-list" style="font-size:0.8rem; color:#aaa;"></div>
            </div>
            <div>
               <div style="color:#1976d2; font-size:0.8rem;">ä¸»éšŠæ‰‹ç‰Œ</div>
               <div id="home-hand-list" style="font-size:0.8rem; color:#aaa;"></div>
            </div>
         </div>
         <button class="menu-btn primary" style="margin-top:20px;" onclick="startGameFromSetup()">é–‹å§‹æ¯”è³½ï¼</button>
      </div>
    </div>

  </div>
</div>

<!-- 3. ä¸»éŠæˆ²ç•«é¢ -->
<div class="game-wrapper blur" id="main-game">
  
  <header class="scoreboard">
    <div class="team-info">
      <div class="team-logo vis-logo">V</div>
      <div style="font-weight:bold; color:var(--vis-color)">VISITOR</div>
    </div>
    <div class="score-grid">
      <div class="cell header"></div>
      <div class="cell header">1</div><div class="cell header">2</div><div class="cell header">3</div>
      <div class="cell header">4</div><div class="cell header">5</div><div class="cell header">6</div>
      <div class="cell header">7</div><div class="cell header">8</div><div class="cell header">9</div>
      <div class="cell header total">R</div>

      <div class="cell team-name">VIS</div>
      <div class="cell active-score">0</div><div class="cell">0</div><div class="cell">0</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell total" id="score-vis-total">0</div>

      <div class="cell team-name">HOME</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell total" id="score-home-total">0</div>
    </div>
    <div class="status-panel">
      <div class="bso-row">
        <span>B</span> <div class="lights"><div class="light" id="light-b1"></div><div class="light" id="light-b2"></div><div class="light" id="light-b3"></div></div>
      </div>
      <div class="bso-row">
        <span>S</span> <div class="lights"><div class="light" id="light-s1"></div><div class="light" id="light-s2"></div></div>
      </div>
      <div class="bso-row">
        <span>O</span> <div class="lights"><div class="light" id="light-o1"></div><div class="light" id="light-o2"></div></div>
      </div>
      <div style="margin-top:4px; font-size:0.9rem; color:#fff;">1å±€ä¸Š</div>
    </div>
  </header>

  <main class="main-area">
    <section class="field-container">
      <div class="field">
        <div class="mound"></div>
        <div class="infield-diamond rotated">
          <div class="base second"></div>
          <div class="base first"></div>
          <div class="base third"></div>
          <div class="base home"></div>
        </div>
        
        <div class="baseball" id="ball"></div>
        <div class="runner-dot" id="runner-0" style="display:none;"></div>
        <div class="runner-dot" id="runner-1"></div>
        <div class="runner-dot" id="runner-2"></div>
        <div class="runner-dot" id="runner-3"></div>
      </div>
    </section>

    <section class="interaction-panel">
      <div class="battle-slots">
        <div class="slot-box" id="slot-atk">
          <div class="slot-icon" id="icon-atk">âš”ï¸</div>
          <div class="slot-label">æ”»æ–¹ ATK</div>
          <div class="slot-name" id="name-atk">ç­‰å¾…é¸æ“‡</div>
        </div>
        <div style="font-weight:900; font-style:italic; color:#555; font-size:1.5rem;">VS</div>
        <div class="slot-box" id="slot-def">
          <div class="slot-icon" id="icon-def">ğŸ›¡ï¸</div>
          <div class="slot-label">å®ˆæ–¹ DEF</div>
          <div class="slot-name" id="name-def">ç­‰å¾…é¸æ“‡</div>
        </div>
      </div>

      <!-- å‹•æ…‹æ’å…¥æ‰‹ç‰Œ -->
      <div class="decks-container">
        <div class="deck-column" id="deck-col-vis">
          <div class="deck-header" style="color:var(--vis-color)">å®¢éšŠæ‰‹ç‰Œ</div>
          <div id="vis-cards-area"></div>
        </div>
        <div class="deck-column" id="deck-col-home">
          <div class="deck-header" style="color:var(--home-color)">ä¸»éšŠæ‰‹ç‰Œ</div>
          <div id="home-cards-area"></div>
        </div>
      </div>

      <div class="controls">
        <div class="dice-display">
          <div class="die" id="d1">?</div>
          <div class="die" id="d2">?</div>
        </div>
        <div class="status-text">
          <div class="main-status" id="main-status">æ¯”è³½é–‹å§‹</div>
          <div class="sub-status" id="sub-status">è«‹é›™æ–¹é¸æ“‡å¡ç‰Œæˆ–ç›´æ¥æŠ•çƒ</div>
        </div>
        <button class="play-btn" id="play-btn" onclick="startTurn()">æ“²éª°å­ (ROLL)</button>
      </div>
    </section>
  </main>
</div>

<script>
  /* --- 0. è³‡æ–™åº«: 20 å¼µå¡ç‰‡å®šç¾© --- */
  const CARD_DB = {
    ATK: [
      { id: 'a1', name: 'å…¨åŠ›æ®æ“Š', icon: 'ğŸ’ª', desc: 'ä¸€å®‰â†’äºŒå®‰ï¼ŒäºŒå®‰â†’å…¨å£˜æ‰“' },
      { id: 'a2', name: 'é¸çƒçœ¼', icon: 'ğŸ‘ï¸', desc: 'éª°å‡º 4-6 (æ»¾åœ°) å¯é‡éª°' },
      { id: 'a3', name: 'å¹¸é‹æ˜Ÿ', icon: 'ğŸŒŸ', desc: 'é»æ•¸ç¸½å’Œ +1' },
      { id: 'a4', name: 'æ»¿è²«ç ²', icon: 'ğŸ†', desc: 'æ»¿å£˜æ™‚è‹¥å®‰æ‰“ï¼Œè¦–ç‚ºå…¨å£˜æ‰“' },
      { id: 'a5', name: 'çŸ­æ‰“æˆ°è¡“', icon: 'ğŸ', desc: 'çŠ§ç‰²æ‰“ï¼šæ¨é€²è·‘è€…ï¼Œæ‰“è€…å‡ºå±€' },
      { id: 'a6', name: 'ç›œå£˜æŒ‡ä»¤', icon: 'ğŸ‘Ÿ', desc: 'éš¨æ©Ÿä¸€åè·‘è€…å‰é€²ä¸€å€‹å£˜åŒ…' },
      { id: 'a7', name: 'æµæ˜Ÿæ‰“', icon: 'â˜„ï¸', desc: 'ç„¡è¦–å°æ‰‹æœ¬å›åˆé˜²ç¦¦å¡' },
      { id: 'a8', name: 'ç¥é æ¸¬', icon: 'ğŸ”®', desc: 'è‹¥éª°å‡ºç¸½å’Œ < 7ï¼Œè‡ªå‹•é‡éª°' },
      { id: 'a9', name: 'æ•™ç·´å–Šè©±', icon: 'ğŸ“£', desc: 'å°‡ä¸‰æŒ¯ (2,3) è½‰ç‚ºä¿é€' },
      { id: 'a10', name: 'å†ä¸€æ¬¡', icon: 'ğŸ”„', desc: 'ç„¡æ¢ä»¶é‡éª°é€™ä¸€æ¬¡çµæœ' }
    ],
    DEF: [
      { id: 'd1', name: 'å®ˆå‚™ä½ˆé™£', icon: 'ğŸ§¤', desc: 'ä¸€å£˜å®‰æ‰“ â†’ æ»¾åœ°å‡ºå±€' },
      { id: 'd2', name: 'éµå£é˜²å®ˆ', icon: 'ğŸ§±', desc: 'äºŒå£˜å®‰æ‰“ä»¥ä¸Š â†’ ä¸€å£˜å®‰æ‰“' },
      { id: 'd3', name: 'ç²¾æº–æ§çƒ', icon: 'ğŸ¯', desc: 'é»æ•¸ç¸½å’Œ -1' },
      { id: 'd4', name: 'é›™æ®ºç¶²', icon: 'ğŸ•¸ï¸', desc: 'è‹¥æ»¾åœ°ä¸”ä¸€å£˜æœ‰äºº â†’ é›™æ®º' },
      { id: 'd5', name: 'é›·å°„è‚©', icon: 'âš¡', desc: 'è·‘è€…ç„¡æ³•å¤šæ¨é€²å£˜åŒ…' },
      { id: 'd6', name: 'è®Šé€Ÿçƒ', icon: 'ğŸŒ', desc: 'å°æ‰‹å¿…é ˆé‡éª°æ•¸å€¼è¼ƒå¤§çš„éª°å­' },
      { id: 'd7', name: 'å¨åš‡', icon: 'ğŸ˜ ', desc: 'ç„¡æ•ˆåŒ–å°æ‰‹çš„æ”»æ“Šå¡' },
      { id: 'd8', name: 'å£çƒé‡£é­š', icon: 'ğŸ£', desc: 'å°‡å››å£ä¿é€è½‰ç‚ºå£çƒ' },
      { id: 'd9', name: 'å…¨å£˜æ‰“ç‰†', icon: 'ğŸš§', desc: 'å…¨å£˜æ‰“ â†’ äºŒå£˜å®‰æ‰“' },
      { id: 'd10', name: 'å¹²æ“¾æˆ°è¡“', icon: 'ğŸº', desc: 'å¼·åˆ¶å°æ‰‹é‡éª°æ•¸å€¼è¼ƒå°çš„éª°å­' }
    ]
  };

  /* --- 1. å…¨åŸŸç‹€æ…‹ --- */
  let appState = {
    p1Color: '#d32f2f',
    p2Color: '#1976d2',
    p1Roll: 0,
    p2Roll: 0,
    visTeam: 'P1', // P1 or P2
    homeTeam: 'P2',
    visHand: [], // Array of card objects
    homeHand: [],
    
    // éŠæˆ²å…§ç‹€æ…‹
    phase: 'PLANNING',
    runners: [false, false, false], // 1B, 2B, 3B
    outs: 0,
    balls: 0,
    strikes: 0,
    inning: 1,
    isTop: true, // ä¸ŠåŠå±€
    score: { vis: 0, home: 0 },
    selectedAtk: null,
    selectedDef: null,
    visCardsUsed: [], // ids
    homeCardsUsed: [] // ids
  };

  const COLORS = ['#d32f2f', '#1976d2', '#388e3c', '#fbc02d', '#7b1fa2', '#e64a19', '#5d4037', '#455a64'];
  const POSITIONS = {
    home:    { top: '79.7%', left: '50%' },
    first:   { top: '50%',   left: '79.7%' },
    second:  { top: '20.3%', left: '50%' },
    third:   { top: '50%',   left: '20.3%' },
    pitcher: { top: '50%',   left: '50%' },
    outfieldLeft:  { top: '15%', left: '20%' },
    outfieldRight: { top: '15%', left: '80%' },
    infield:       { top: '35%', left: '65%' }
  };

  /* --- 2. ä»‹é¢æ§åˆ¶é‚è¼¯ (Setup Flow) --- */

  function init() {
    renderColorPickers();
  }

  function showGallery() {
    const grid = document.getElementById('gallery-content');
    grid.innerHTML = '';
    // ATK
    CARD_DB.ATK.forEach(c => {
      const el = document.createElement('div');
      el.className = 'card-preview atk';
      el.innerHTML = `<div style="font-size:2rem">${c.icon}</div><div style="font-weight:bold; font-size:0.9rem">${c.name}</div><div style="font-size:0.7rem; color:#aaa">${c.desc}</div>`;
      grid.appendChild(el);
    });
    // DEF
    CARD_DB.DEF.forEach(c => {
      const el = document.createElement('div');
      el.className = 'card-preview def';
      el.innerHTML = `<div style="font-size:2rem">${c.icon}</div><div style="font-weight:bold; font-size:0.9rem">${c.name}</div><div style="font-size:0.7rem; color:#aaa">${c.desc}</div>`;
      grid.appendChild(el);
    });
    document.getElementById('gallery-screen').classList.remove('hidden');
  }

  function closeGallery() {
    document.getElementById('gallery-screen').classList.add('hidden');
  }

  function goToSetup() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
  }

  function renderColorPickers() {
    const p1c = document.getElementById('p1-colors');
    const p2c = document.getElementById('p2-colors');
    
    COLORS.forEach(c => {
      // P1 Picker
      let dot1 = document.createElement('div');
      dot1.className = 'color-option';
      dot1.style.backgroundColor = c;
      if(c === appState.p1Color) dot1.classList.add('selected');
      dot1.onclick = () => {
        appState.p1Color = c;
        renderColorPickers();
      };
      p1c.appendChild(dot1);

      // P2 Picker
      let dot2 = document.createElement('div');
      dot2.className = 'color-option';
      dot2.style.backgroundColor = c;
      if(c === appState.p2Color) dot2.classList.add('selected');
      dot2.onclick = () => {
        appState.p2Color = c;
        renderColorPickers();
      };
      p2c.appendChild(dot2);
    });
    
    // Clear previous before append (dumb way for proto)
    p1c.innerHTML = ''; p2c.innerHTML = '';
    COLORS.forEach(c => {
      let d1 = document.createElement('div');
      d1.className = `color-option ${c===appState.p1Color?'selected':''}`;
      d1.style.backgroundColor=c;
      d1.onclick=()=>{appState.p1Color=c; renderColorPickers();}
      p1c.appendChild(d1);

      let d2 = document.createElement('div');
      d2.className = `color-option ${c===appState.p2Color?'selected':''}`;
      d2.style.backgroundColor=c;
      d2.onclick=()=>{appState.p2Color=c; renderColorPickers();}
      p2c.appendChild(d2);
    });
  }

  function goToInitiative() {
    document.getElementById('step-color').style.display = 'none';
    document.getElementById('step-initiative').style.display = 'block';
  }

  function rollInitiative(player) {
    const val = Math.floor(Math.random() * 100) + 1;
    if(player === 1) {
      appState.p1Roll = val;
      document.getElementById('p1-roll').innerText = val;
      document.getElementById('btn-roll-p1').disabled = true;
    } else {
      appState.p2Roll = val;
      document.getElementById('p2-roll').innerText = val;
      document.getElementById('btn-roll-p2').disabled = true;
    }

    if(appState.p1Roll > 0 && appState.p2Roll > 0) {
      const res = document.getElementById('initiative-result');
      if(appState.p1Roll > appState.p2Roll) {
        res.innerText = "P1 é»æ•¸è¼ƒå¤§ï¼ŒP1 ç‚ºä¸»éšŠ (å¾Œæ”»)";
        appState.homeTeam = 'P1'; appState.visTeam = 'P2';
      } else {
        res.innerText = "P2 é»æ•¸è¼ƒå¤§ï¼ŒP2 ç‚ºä¸»éšŠ (å¾Œæ”»)";
        appState.homeTeam = 'P2'; appState.visTeam = 'P1';
      }
      document.getElementById('btn-go-draw').style.display = 'block';
    }
  }

  function goToDraw() {
    document.getElementById('step-initiative').style.display = 'none';
    document.getElementById('step-draw').style.display = 'block';
  }

  function drawCardsAnimation() {
    // Random 3 cards for each side
    // Logic: Vis gets 3 ATK, 3 DEF. Home gets 3 ATK, 3 DEF.
    // Simplified: Actually, usually Attack Team uses Atk cards, Def Team uses Def cards.
    // So both players need ATK and DEF cards because they will switch sides.
    
    // Draw 3 unique indices
    const draw = (arr, count) => {
      const shuffled = [...arr].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    };

    const p1Atk = draw(CARD_DB.ATK, 3);
    const p1Def = draw(CARD_DB.DEF, 3);
    const p2Atk = draw(CARD_DB.ATK, 3);
    const p2Def = draw(CARD_DB.DEF, 3);

    // Combine hand
    const p1Hand = [...p1Atk, ...p1Def];
    const p2Hand = [...p2Atk, ...p2Def];

    // Assign to Vis/Home based on role
    if(appState.visTeam === 'P1') {
      appState.visHand = p1Hand;
      appState.homeHand = p2Hand;
    } else {
      appState.visHand = p2Hand;
      appState.homeHand = p1Hand;
    }

    // UI Update
    const renderList = (hand, elId) => {
      const el = document.getElementById(elId);
      el.innerHTML = hand.map(c => `[${c.icon} ${c.name}]`).join(' ');
    };
    renderList(appState.visHand, 'vis-hand-list');
    renderList(appState.homeHand, 'home-hand-list');

    document.getElementById('draw-result-area').style.display = 'block';
  }

  function startGameFromSetup() {
    // Apply colors to CSS vars
    document.documentElement.style.setProperty('--vis-color', appState.visTeam==='P1' ? appState.p1Color : appState.p2Color);
    document.documentElement.style.setProperty('--home-color', appState.homeTeam==='P1' ? appState.p1Color : appState.p2Color);
    
    // Render Game Hands
    updateHandUI('vis');
    updateHandUI('home');

    // Transition
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('main-game').classList.remove('blur');
  }

  /* --- 3. éŠæˆ²æ ¸å¿ƒé‚è¼¯ (Game Loop) --- */
  
  // DOM Elements
  const ball = document.getElementById('ball');
  const d1 = document.getElementById('d1');
  const d2 = document.getElementById('d2');
  const statusMain = document.getElementById('main-status');
  const statusSub = document.getElementById('sub-status');
  const btn = document.getElementById('play-btn');

  function updateHandUI(side) {
    const isVis = side === 'vis';
    const hand = isVis ? appState.visHand : appState.homeHand;
    const usedList = isVis ? appState.visCardsUsed : appState.homeCardsUsed;
    const container = document.getElementById(isVis ? 'vis-cards-area' : 'home-cards-area');
    
    container.innerHTML = '';
    
    // Filter cards based on current role (Attacker should see ATK cards, Defender DEF cards)
    // Current Attacker: If Top Inning -> Vis, Bottom Inning -> Home
    const currentAtkTeam = appState.isTop ? 'vis' : 'home';
    const showAtkCards = (side === currentAtkTeam);

    hand.forEach(card => {
      const isAtkCard = CARD_DB.ATK.some(c => c.id === card.id);
      
      // Only show relevant cards (Atk cards for attacker, Def for defender)
      if ( (showAtkCards && isAtkCard) || (!showAtkCards && !isAtkCard) ) {
        const isUsed = usedList.includes(card.id);
        const el = document.createElement('div');
        el.className = `card ${isUsed ? 'used disabled' : ''}`;
        el.onclick = () => selectCard(side, card, el);
        el.innerHTML = `
          <div class="card-icon">${card.icon}</div>
          <div class="card-info">
            <div class="card-title">${card.name}</div>
            <div class="card-effect">${card.desc}</div>
          </div>
        `;
        container.appendChild(el);
      }
    });
  }

  function selectCard(side, card, el) {
    if (appState.phase !== 'PLANNING') return;
    
    // Toggle Logic
    const isAtk = CARD_DB.ATK.some(c => c.id === card.id);
    const targetSlot = isAtk ? 'atk' : 'def';
    
    // Remove selection from siblings
    el.parentElement.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));

    // Check if deselecting
    if ( (isAtk && appState.selectedAtk?.id === card.id) || (!isAtk && appState.selectedDef?.id === card.id) ) {
      if(isAtk) appState.selectedAtk = null; else appState.selectedDef = null;
      updateSlot(targetSlot, null);
    } else {
      el.classList.add('selected');
      if(isAtk) appState.selectedAtk = card; else appState.selectedDef = card;
      updateSlot(targetSlot, card);
    }
  }

  function updateSlot(type, card) {
    const box = document.getElementById(`slot-${type}`);
    const icon = document.getElementById(`icon-${type}`);
    const name = document.getElementById(`name-${type}`);
    
    if(card) {
      box.classList.add('filled', `${type}-filled`);
      icon.innerText = card.icon;
      name.innerText = card.name;
    } else {
      box.className = 'slot-box'; // reset
      icon.innerText = type === 'atk' ? 'âš”ï¸' : 'ğŸ›¡ï¸';
      name.innerText = 'ç­‰å¾…é¸æ“‡';
    }
  }

  function startTurn() {
    if (appState.phase === 'RESOLVED') {
      resetTurn();
      return;
    }
    
    appState.phase = 'ROLLING';
    btn.disabled = true;
    statusMain.innerText = "æŠ•çƒä¸­...";
    
    resetBallPosition('pitcher');
    ball.classList.add('animate');
    moveBallTo('home', 600);
    d1.classList.add('rolling');
    d2.classList.add('rolling');

    setTimeout(() => {
      const v1 = Math.floor(Math.random()*6)+1;
      const v2 = Math.floor(Math.random()*6)+1;
      d1.innerText = v1; d2.innerText = v2;
      d1.classList.remove('rolling'); d2.classList.remove('rolling');
      resolveResult(v1+v2);
    }, 800);
  }

  function resolveResult(total) {
    appState.phase = 'ANIMATING';
    let type = getBaseOutcome(total);
    let msg = `åŸå§‹çµæœ: ${type}`;

    // Apply Cards Logic
    // 1. ATK Cards
    if (appState.selectedAtk) {
        const id = appState.selectedAtk.id;
        // Mark used
        if(appState.isTop) appState.visCardsUsed.push(id); else appState.homeCardsUsed.push(id);
        
        // Effects
        if(id === 'a1' && type === 'Single') { type = 'Double'; msg = 'å…¨åŠ›æ®æ“Šç”Ÿæ•ˆï¼'; }
        if(id === 'a1' && type === 'Double') { type = 'HR'; msg = 'å…¨åŠ›æ®æ“Šç”Ÿæ•ˆï¼å…¨å£˜æ‰“ï¼'; }
        if(id === 'a3') { total += 1; type = getBaseOutcome(total); msg = 'å¹¸é‹æ˜Ÿ +1 é»ï¼'; }
        if(id === 'a9' && type === 'StrikeOut') { type = 'Walk'; msg = 'æ•™ç·´å–Šè©±ï¼šé¸åˆ°ä¿é€ï¼'; }
        if(id === 'a8' && total < 7) { 
           msg = 'ç¥é æ¸¬ï¼šé‡éª°ï¼'; 
           // ç°¡åŒ–ï¼šç›´æ¥è¦–ç‚º Single 
           type = 'Single'; 
        }
    }

    // 2. DEF Cards (Counter)
    if (appState.selectedDef) {
        const id = appState.selectedDef.id;
        // Mark used
        if(!appState.isTop) appState.visCardsUsed.push(id); else appState.homeCardsUsed.push(id);
        
        // Ignored by Meteor Hit
        if(appState.selectedAtk?.id === 'a7') {
           msg += ' (æµæ˜Ÿæ‰“ç„¡è¦–é˜²ç¦¦)';
        } else {
           if(id === 'd1' && type === 'Single') { type = 'GroundOut'; msg = 'å®ˆå‚™ä½ˆé™£æ””æˆªï¼'; }
           if(id === 'd2' && (type === 'Double' || type === 'Triple' || type === 'HR')) { type = 'Single'; msg = 'éµå£é˜²å®ˆæ“‹ä¸‹é•·æ‰“ï¼'; }
           if(id === 'd3') { total -= 1; type = getBaseOutcome(total); msg = 'ç²¾æº–æ§çƒ -1 é»ï¼'; }
           if(id === 'd9' && type === 'HR') { type = 'Double'; msg = 'å…¨å£˜æ‰“ç‰†æ“‹ä¸‹ï¼'; }
        }
    }

    statusMain.innerText = type;
    statusSub.innerText = msg;
    
    performFieldAnimation(type);
    
    // Update Score Logic (Simplified)
    setTimeout(() => {
        handleGameLogic(type);
        endTurn();
    }, 2000);
  }

  function getBaseOutcome(sum) {
    if (sum <= 3) return 'StrikeOut';
    if (sum >= 4 && sum <= 6) return 'GroundOut';
    if (sum === 7 || sum === 8) return 'Single';
    if (sum === 9 || sum === 10) return 'Double';
    if (sum === 11) return 'Triple';
    if (sum === 12) return 'HR';
    return 'Out';
  }

  function handleGameLogic(type) {
      // ç°¡å–®çš„è·‘å£˜é‚è¼¯
      if(type === 'Single') {
          // æ»¿å£˜æ“ å›ä¸€åˆ†ï¼Œå…¶ä»–æ¨é€²
          if(appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
          appState.runners[2] = appState.runners[1];
          appState.runners[1] = appState.runners[0];
          appState.runners[0] = true;
      } else if (type === 'Double') {
          if(appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
          if(appState.runners[1]) appState.score[appState.isTop?'vis':'home']++;
          appState.runners[2] = appState.runners[0];
          appState.runners[1] = true;
          appState.runners[0] = false;
      } else if (type === 'HR') {
          let runs = 1 + (appState.runners[0]?1:0) + (appState.runners[1]?1:0) + (appState.runners[2]?1:0);
          appState.score[appState.isTop?'vis':'home'] += runs;
          appState.runners = [false,false,false];
      } else if (type === 'Walk') {
          // æ“ å£˜
          if(appState.runners[0] && appState.runners[1] && appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
          else if (appState.runners[0] && appState.runners[1]) appState.runners[2] = true;
          else if (appState.runners[0]) appState.runners[1] = true;
          appState.runners[0] = true;
      } else {
          // Outs
          appState.outs++;
      }
      
      updateScoreboard();
      updateRunnersDisplay();
  }

  function updateScoreboard() {
      // é€™è£¡åƒ…æ›´æ–°ç¸½åˆ†ï¼Œå±€æ•¸ç´°ç¯€ç•¥éä»¥ä¿æŒ demo ç°¡æ½”
      document.getElementById('score-vis-total').innerText = appState.score.vis;
      document.getElementById('score-home-total').innerText = appState.score.home;
      
      // Update Lights
      for(let i=1; i<=2; i++) document.getElementById(`light-o${i}`).className = `light ${i<=appState.outs ? 'on-red':''}`;
      
      if(appState.outs >= 3) {
          appState.outs = 0;
          appState.runners = [false,false,false];
          appState.isTop = !appState.isTop;
          if(appState.isTop) appState.inning++;
          
          // Switch Sides Text
          statusMain.innerText = "æ”»å®ˆäº¤æ›";
          statusSub.innerText = `ç¬¬ ${appState.inning} å±€ ${appState.isTop?'ä¸Š':'ä¸‹'}`;
          
          // Refresh Cards UI for new Attacker/Defender
          updateHandUI('vis');
          updateHandUI('home');
      }
  }

  /* --- Animation Utils --- */
  function resetBallPosition(posName) {
    ball.style.top = POSITIONS[posName].top;
    ball.style.left = POSITIONS[posName].left;
    ball.style.opacity = 1;
  }
  function moveBallTo(posName, duration = 500) {
    ball.style.transition = `top ${duration}ms ease-out, left ${duration}ms ease-out`;
    void ball.offsetWidth;
    ball.style.top = POSITIONS[posName].top;
    ball.style.left = POSITIONS[posName].left;
  }
  function performFieldAnimation(type) {
    if (type === 'StrikeOut' || type === 'Out') ball.style.opacity = 0;
    else if (type === 'GroundOut') moveBallTo('infield', 400);
    else if (type === 'Single' || type === 'Walk') moveBallTo('outfieldRight', 600);
    else if (type === 'Double') moveBallTo('outfieldLeft', 800);
    else if (type === 'HR') {
      ball.style.transition = "top 1s ease-in, left 1s linear, transform 1s ease-in";
      ball.style.top = "-10%"; ball.style.left = "20%"; ball.style.transform = "scale(0.5)";
    }
  }
  function updateRunnersDisplay() {
    const bases = ['first', 'second', 'third'];
    for(let i=0; i<3; i++) {
      const el = document.getElementById(`runner-${i+1}`);
      // Set runner color based on current attacking team
      el.className = `runner-dot ${appState.isTop ? '' : 'home-team'} ${appState.runners[i] ? 'active' : ''}`;
      if(appState.runners[i]) {
          el.style.top = POSITIONS[bases[i]].top;
          el.style.left = POSITIONS[bases[i]].left;
      }
    }
  }

  function endTurn() {
    appState.phase = 'RESOLVED';
    btn.disabled = false;
    btn.innerText = "ä¸‹ä¸€æ‰“å¸­";
  }

  function resetTurn() {
    appState.phase = 'PLANNING';
    appState.selectedAtk = null;
    appState.selectedDef = null;
    
    // UI Reset
    updateSlot('atk', null);
    updateSlot('def', null);
    
    // Re-render hands (to gray out used cards)
    updateHandUI('vis');
    updateHandUI('home');
    
    ball.style.opacity = 0; ball.style.transform = "none";
    d1.innerText = "?"; d2.innerText = "?";
    statusMain.innerText = "è«‹é¸æ“‡æˆ°è¡“å¡";
    btn.innerText = "æ“²éª°å­ (ROLL)";
  }

  // init
  init();

</script>
</body>
</html>
