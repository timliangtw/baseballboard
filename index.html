<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ£’çƒæ£‹ V5: ç¶“å…¸é‚„åŸç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- åŸºç¤è¨­å®š --- */
    :root {
      --bg-color: #2b2f3a;
      --panel-bg: #20232b;
      --accent-color: #f8b739;
      --vis-color: #d32f2f;
      --home-color: #1976d2;
      --field-grass: #3c6e47;
      --field-dirt: #8d6e63;
      --line-color: rgba(255, 255, 255, 0.8);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-color); color: #f5f5f5;
      display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
    }

    .overlay-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(30, 34, 45, 0.98);
      z-index: 100;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    .overlay-screen.hidden { opacity: 0; pointer-events: none; }

    .title-logo { font-size: 3rem; font-weight: 900; color: var(--accent-color); margin-bottom: 30px; text-shadow: 0 0 20px rgba(248,183,57,0.5); letter-spacing: 2px; }
    
    .menu-btn {
      width: 220px; padding: 15px; margin: 10px; border: 2px solid var(--accent-color);
      background: transparent; color: var(--accent-color); font-size: 1.2rem; font-weight: bold;
      cursor: pointer; border-radius: 50px; transition: all 0.2s;
    }
    .menu-btn:hover { background: var(--accent-color); color: #222; transform: scale(1.05); }
    .menu-btn.primary { background: var(--accent-color); color: #222; }

    /* è¨­å®šç•«é¢ */
    .setup-container { width: 90%; max-width: 600px; background: #252a36; padding: 20px; border-radius: 16px; text-align: center; }
    .color-picker-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: transform 0.2s; }
    .color-option.selected { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    
    .initiative-area { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; background: #1a1d26; padding: 15px; border-radius: 12px; }
    .player-setup-box { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .roll-num { font-size: 2rem; font-weight: bold; min-width: 60px; }

    /* åœ–é‘‘èˆ‡æŠ½å¡ç•«é¢ */
    .gallery-grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
      gap: 10px; width: 90%; max-width: 800px; max-height: 70vh; overflow-y: auto; padding: 10px;
    }
    .card-preview {
      background: #2c303a; border: 1px solid #444; border-radius: 8px; padding: 10px;
      display: flex; flex-direction: column; align-items: center; text-align: center;
    }
    .card-preview.atk { border-top: 4px solid var(--accent-color); }
    .card-preview.def { border-top: 4px solid #448aff; }
    
    /* éŠæˆ²ä¸»é«” */
    .game-wrapper {
      width: 100%; max-width: 1100px; height: 100vh; max-height: 800px;
      background: var(--panel-bg); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      padding: 12px; display: flex; flex-direction: column; gap: 10px;
      filter: blur(0); transition: filter 0.5s;
    }
    .game-wrapper.blur { filter: blur(10px); }

    /* é ‚éƒ¨è¨ˆåˆ†æ¿ */
    .scoreboard {
      display: grid; grid-template-columns: 1.5fr 3fr 1.2fr; gap: 10px; padding: 10px 15px;
      background: #000; border-radius: 10px; align-items: center; border: 2px solid #333;
    }
    .team-info { display: flex; align-items: center; gap: 10px; }
    .team-logo { 
      width: 40px; height: 40px; border-radius: 50%; background: #444; 
      display: grid; place-items: center; font-weight: bold; font-size: 0.9rem;
    }
    .vis-logo { background: var(--vis-color); color: white; }
    .home-logo { background: var(--home-color); color: white; }

    .score-grid { display: grid; grid-template-columns: 2.5em repeat(9, 1fr) 2em; gap: 2px; font-family: monospace; font-weight: bold; }
    .score-grid .cell { background: #222; color: #555; text-align: center; padding: 4px 0; font-size: 0.85rem; border-radius: 2px; }
    .score-grid .header { color: #888; font-size: 0.6rem; background: transparent; }
    .score-grid .total { color: var(--accent-color); font-size: 1rem; }
    .score-grid .active-score { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
    .score-grid .team-name { text-align: left; padding-left: 5px; color: #fff; }

    .status-panel { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; font-family: monospace; }
    .bso-row { display: flex; gap: 6px; align-items: center; font-size: 0.75rem; color: #aaa; }
    .lights { display: flex; gap: 3px; }
    .light { width: 8px; height: 8px; border-radius: 50%; background: #333; border: 1px solid #444; }
    .light.on-green { background: #00e676; box-shadow: 0 0 5px #00e676; }
    .light.on-yellow { background: #ffeb3b; box-shadow: 0 0 5px #ffeb3b; }
    .light.on-red { background: #ff1744; box-shadow: 0 0 5px #ff1744; }

    /* ä¸»å€åŸŸ */
    .main-area { flex: 1; display: grid; grid-template-columns: 1.6fr 1.4fr; gap: 12px; min-height: 0; }

    /* çƒå ´ */
    .field-container {
      background: #181b23; border-radius: 16px; padding: 10px; position: relative;
      display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .field {
      position: relative; width: 100%; max-width: 450px; aspect-ratio: 1/1;
      background: radial-gradient(circle at 50% 50%, var(--field-dirt) 22%, transparent 23%), linear-gradient(0deg, var(--field-grass) 50%, #2e5a36 50%);
      background-size: 100% 100%, 100% 30px;
      border-radius: 12px; border: 4px solid #1a2e1e;
    }
    .infield-diamond {
      position: absolute; top: 50%; left: 50%; width: 42%; height: 42%;
      border: 2px solid var(--line-color); transform: translate(-50%, -50%) rotate(-45deg);
      box-sizing: border-box; z-index: 5;
    }
    .base { position: absolute; width: 20px; height: 20px; background: #fff; transform: translate(0, 0); box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .base.second { top: -10px; left: -10px; } 
    .base.first  { top: -10px; right: -10px; }
    .base.home   { bottom: -10px; right: -10px; border-radius: 2px 2px 10px 2px; }
    .base.third  { bottom: -10px; left: -10px; }
    .mound { 
      position: absolute; top: 50%; left: 50%; width: 34px; height: 34px; 
      background: var(--field-dirt); border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.2); z-index: 4;
    }
    .runner-dot {
      position: absolute; width: 22px; height: 22px; 
      background: var(--vis-color); border: 2px solid #fff; border-radius: 50%;
      transform: translate(-50%, -50%) scale(0); transition: top 0.6s linear, left 0.6s linear;
      z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); top: 50%; left: 50%;
    }
    .runner-dot.active { transform: translate(-50%, -50%) scale(1); }
    .runner-dot.home-team { background: var(--home-color); }

    .baseball {
      position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.5); z-index: 20; top: 50%; left: 50%; opacity: 0; pointer-events: none;
    }
    .baseball.animate { opacity: 1; transition: top 0.4s ease-out, left 0.4s ease-out; }

    /* äº’å‹•å€ */
    .interaction-panel { display: flex; flex-direction: column; gap: 10px; }
    .battle-slots {
      display: flex; justify-content: center; align-items: center; gap: 10px;
      background: #1a1a1a; padding: 10px; border-radius: 12px; min-height: 110px;
    }
    .slot-box {
      width: 90px; height: 100px; border: 2px dashed #444; border-radius: 8px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.3s; position: relative; overflow: hidden;
    }
    .slot-box.filled { border-style: solid; background: #2a2a2a; border-color: #666; }
    .slot-box.atk-filled { border-color: var(--accent-color); background: rgba(248, 183, 57, 0.1); }
    .slot-box.def-filled { border-color: #448aff; background: rgba(68, 138, 255, 0.1); }
    .slot-icon { font-size: 2.5rem; margin-bottom: 5px; }
    .slot-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
    .slot-name { font-size: 0.8rem; font-weight: bold; text-align: center; line-height: 1.1; }

    .decks-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; min-height: 200px;}
    .deck-column { display: flex; flex-direction: column; gap: 6px; }
    .deck-header { font-size: 0.8rem; text-align: center; padding-bottom: 4px; border-bottom: 2px solid #333; margin-bottom: 4px; }
    
    .card {
      background: #2c303a; border-radius: 8px; padding: 8px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; border: 1px solid transparent;
      transition: transform 0.1s, background 0.2s; position: relative;
    }
    .card:hover { background: #353a45; transform: translateY(-2px); }
    .card.selected { border-color: #fff; background: #444; }
    .card.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    .card.used::after { content: 'å·²ä½¿ç”¨'; position: absolute; inset:0; background:rgba(0,0,0,0.7); display:grid; place-items:center; color:#fff; font-size:0.8rem; border-radius:8px;}
    .card-icon { font-size: 1.8rem; width: 35px; text-align: center; }
    .card-info { flex: 1; }
    .card-title { font-size: 0.85rem; font-weight: bold; color: #eee; }
    .card-effect { font-size: 0.6rem; color: #aaa; }

    .controls {
      background: #252a36; padding: 10px; border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .dice-display { display: flex; gap: 15px; margin-bottom: 5px; }
    .die {
      width: 48px; height: 48px; background: #eee; border-radius: 8px; color: #222;
      font-size: 1.6rem; font-weight: 800; display: grid; place-items: center; box-shadow: 0 4px 0 #bbb;
    }
    .die.rolling { animation: shake 0.2s infinite; background: #ddd; }
    .status-text { text-align: center; height: 2.5em; display: flex; flex-direction: column; justify-content: center; }
    .main-status { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .sub-status { font-size: 0.8rem; color: var(--accent-color); }
    .play-btn {
      width: 100%; padding: 12px; border-radius: 50px; border: none;
      background: linear-gradient(135deg, var(--accent-color), #e6a320);
      font-size: 1.1rem; font-weight: bold; color: #222; cursor: pointer;
      box-shadow: 0 4px 10px rgba(248, 183, 57, 0.4); transition: transform 0.1s;
    }
    .play-btn:active { transform: scale(0.98); }
    .play-btn:disabled { background: #555; color: #888; box-shadow: none; }

    @keyframes shake { 0% {transform:rotate(5deg);} 50% {transform:rotate(-5deg);} 100% {transform:rotate(5deg);} }

    /* --- è·‘ç‡ˆæ©Ÿå°æ¨£å¼ (æ–°ç‰ˆ Grid) --- */
    #roll-overlay {
      background: rgba(10, 12, 16, 0.95);
      z-index: 200;
    }
    .machine-container {
      width: 95%; max-width: 600px;
      background: #151515; border: 4px solid #555; border-radius: 12px;
      padding: 15px; text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
      position: relative;
    }
    .machine-title { font-size: 1.5rem; color: #f8b739; margin-bottom: 15px; letter-spacing: 2px; text-transform: uppercase; font-weight: 900; }
    
    .machine-dice-area {
      display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;
    }
    .machine-die {
      width: 50px; height: 50px; background: #fff; border-radius: 8px;
      color: #000; font-size: 1.5rem; font-weight: bold;
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 4px 0 #999;
    }
    .machine-die.rolling { animation: shake 0.1s infinite; background: #ddd; }
    
    /* 3 Column Grid for 21 combinations */
    .result-grid-v2 {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
      background: #222; padding: 10px; border-radius: 8px;
    }
    
    .res-cell {
      background: #333; border: 1px solid #444; border-radius: 4px;
      padding: 6px 2px; color: #aaa; font-family: monospace;
      display: flex; align-items: center; justify-content: space-between;
      transition: all 0.1s; font-size: 0.8rem;
    }
    .res-cell .d-pair { font-weight: bold; color: #fff; margin-left: 5px; }
    .res-cell .d-out { font-size: 0.75rem; margin-right: 5px; text-align: right; }
    
    .res-cell.active {
      background: #d32f2f; border-color: #ff5252; color: #fff;
      box-shadow: 0 0 10px #ff5252; z-index: 10; transform: scale(1.05);
    }
    
  </style>
</head>
<body>

<div id="start-screen" class="overlay-screen">
  <div class="title-logo">BASEBALL BATTLE</div>
  <button class="menu-btn primary" onclick="goToSetup()">é–‹å§‹å°æˆ°</button>
  <button class="menu-btn" onclick="showGallery()">å¡ç‰Œåœ–é‘‘</button>
</div>

<div id="gallery-screen" class="overlay-screen hidden">
  <div style="display:flex; justify-content:space-between; width:90%; max-width:800px; margin-bottom:10px;">
    <h2 style="color:var(--accent-color);">å¡ç‰Œåœ–é‘‘</h2>
    <button class="menu-btn" style="width:100px; padding:5px; font-size:1rem;" onclick="closeGallery()">è¿”å›</button>
  </div>
  <div class="gallery-grid" id="gallery-content"></div>
</div>

<div id="setup-screen" class="overlay-screen hidden">
  <div class="setup-container">
    <h2 style="margin-bottom:20px;">è³½å‰æº–å‚™</h2>
    
    <div id="step-color">
      <div style="display:flex; justify-content:space-between;">
        <div style="text-align:center;">
          <div>P1 (å®¢éšŠ)</div>
          <div class="color-picker-row" id="p1-colors"></div>
        </div>
        <div style="width:2px; background:#444;"></div>
        <div style="text-align:center;">
          <div>P2 (ä¸»éšŠ)</div>
          <div class="color-picker-row" id="p2-colors"></div>
        </div>
      </div>
      <button class="menu-btn primary" onclick="goToInitiative()">ç¢ºèªé¡è‰²</button>
    </div>

    <div id="step-initiative" style="display:none;">
      <h3>æ¯”å¤§å°æ±ºå®šä¸»å®¢å ´</h3>
      <p style="font-size:0.8rem; color:#aaa;">æ•¸å­—å¤§è€…ç‚ºä¸»éšŠ(å¾Œæ”»)</p>
      <div class="initiative-area">
        <div class="player-setup-box">
          <div>P1</div>
          <div class="roll-num" id="p1-roll">-</div>
          <button class="menu-btn" style="width:80px; font-size:0.8rem;" id="btn-roll-p1" onclick="rollInitiative(1)">ROLL</button>
        </div>
        <div style="font-size:1.5rem; font-weight:bold;">VS</div>
        <div class="player-setup-box">
          <div>P2</div>
          <div class="roll-num" id="p2-roll">-</div>
          <button class="menu-btn" style="width:80px; font-size:0.8rem;" id="btn-roll-p2" onclick="rollInitiative(2)">ROLL</button>
        </div>
      </div>
      <div id="initiative-result" style="height:30px; color:var(--accent-color); font-weight:bold;"></div>
      <button class="menu-btn primary" id="btn-go-draw" style="display:none;" onclick="goToDraw()">å‰å¾€æŠ½å¡</button>
    </div>

    <div id="step-draw" style="display:none;">
      <h3>æŠ½å–æœ¬å ´ç‰¹æ®Šå¡ (å„3å¼µ)</h3>
      <div style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
         <div class="card-preview" style="width:120px; height:160px; justify-content:center; cursor:pointer; background:#444;" onclick="drawCardsAnimation()">
           <div style="font-size:3rem;">ğŸ</div>
           <div>é»æ“ŠæŠ½å¡</div>
         </div>
      </div>
      <div id="draw-result-area" style="display:none;">
         <div style="font-size:0.9rem; margin-bottom:10px;">å·²ç²å¾—å¡ç‰Œï¼š</div>
         <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left;">
            <div>
               <div style="color:#d32f2f; font-size:0.8rem;">å®¢éšŠæ‰‹ç‰Œ</div>
               <div id="vis-hand-list" style="font-size:0.8rem; color:#aaa;"></div>
            </div>
            <div>
               <div style="color:#1976d2; font-size:0.8rem;">ä¸»éšŠæ‰‹ç‰Œ</div>
               <div id="home-hand-list" style="font-size:0.8rem; color:#aaa;"></div>
            </div>
         </div>
         <button class="menu-btn primary" style="margin-top:20px;" onclick="startGameFromSetup()">é–‹å§‹æ¯”è³½ï¼</button>
      </div>
    </div>
  </div>
</div>

<!-- æ–°ç‰ˆè·‘ç‡ˆæ©Ÿå° -->
<div id="roll-overlay" class="overlay-screen hidden">
  <div class="machine-container">
    <div class="machine-title">RESULT TABLE</div>
    <div class="machine-dice-area">
      <div class="machine-die" id="m-d1">?</div>
      <div class="machine-die" id="m-d2">?</div>
    </div>
    <!-- 21æ ¼çµæœè¡¨ -->
    <div class="result-grid-v2" id="machine-grid">
       <!-- Generated by JS -->
    </div>
    <div style="margin-top:15px; color:#aaa; font-size:0.8rem;">ç­‰å¾…è·‘ç‡ˆåœæ­¢...</div>
  </div>
</div>

<div class="game-wrapper blur" id="main-game">
  <header class="scoreboard">
    <div class="team-info">
      <div class="team-logo vis-logo">V</div>
      <div style="font-weight:bold; color:var(--vis-color)">VISITOR</div>
    </div>
    <div class="score-grid">
      <div class="cell header"></div>
      <div class="cell header">1</div><div class="cell header">2</div><div class="cell header">3</div>
      <div class="cell header">4</div><div class="cell header">5</div><div class="cell header">6</div>
      <div class="cell header">7</div><div class="cell header">8</div><div class="cell header">9</div>
      <div class="cell header total">R</div>

      <div class="cell team-name">VIS</div>
      <div class="cell active-score">0</div><div class="cell">0</div><div class="cell">0</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell total" id="score-vis-total">0</div>

      <div class="cell team-name">HOME</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell">.</div><div class="cell">.</div><div class="cell">.</div>
      <div class="cell total" id="score-home-total">0</div>
    </div>
    <div class="status-panel">
      <div class="bso-row">
        <span>B</span> <div class="lights"><div class="light" id="light-b1"></div><div class="light" id="light-b2"></div><div class="light" id="light-b3"></div></div>
      </div>
      <div class="bso-row">
        <span>S</span> <div class="lights"><div class="light" id="light-s1"></div><div class="light" id="light-s2"></div></div>
      </div>
      <div class="bso-row">
        <span>O</span> <div class="lights"><div class="light" id="light-o1"></div><div class="light" id="light-o2"></div></div>
      </div>
      <div style="margin-top:4px; font-size:0.9rem; color:#fff;">1å±€ä¸Š</div>
    </div>
  </header>

  <main class="main-area">
    <section class="field-container">
      <div class="field">
        <div class="mound"></div>
        <div class="infield-diamond rotated">
          <div class="base second"></div>
          <div class="base first"></div>
          <div class="base third"></div>
          <div class="base home"></div>
        </div>
        <div class="baseball" id="ball"></div>
        <div class="runner-dot" id="runner-0" style="display:none;"></div>
        <div class="runner-dot" id="runner-1"></div>
        <div class="runner-dot" id="runner-2"></div>
        <div class="runner-dot" id="runner-3"></div>
      </div>
    </section>

    <section class="interaction-panel">
      <div class="battle-slots">
        <div class="slot-box" id="slot-atk">
          <div class="slot-icon" id="icon-atk">âš”ï¸</div>
          <div class="slot-label">æ”»æ–¹ ATK</div>
          <div class="slot-name" id="name-atk">ç­‰å¾…é¸æ“‡</div>
        </div>
        <div style="font-weight:900; font-style:italic; color:#555; font-size:1.5rem;">VS</div>
        <div class="slot-box" id="slot-def">
          <div class="slot-icon" id="icon-def">ğŸ›¡ï¸</div>
          <div class="slot-label">å®ˆæ–¹ DEF</div>
          <div class="slot-name" id="name-def">ç­‰å¾…é¸æ“‡</div>
        </div>
      </div>

      <div class="decks-container">
        <div class="deck-column" id="deck-col-vis">
          <div class="deck-header" style="color:var(--vis-color)">å®¢éšŠæ‰‹ç‰Œ</div>
          <div id="vis-cards-area"></div>
        </div>
        <div class="deck-column" id="deck-col-home">
          <div class="deck-header" style="color:var(--home-color)">ä¸»éšŠæ‰‹ç‰Œ</div>
          <div id="home-cards-area"></div>
        </div>
      </div>

      <div class="controls">
        <div class="dice-display">
          <div class="die" id="d1">?</div>
          <div class="die" id="d2">?</div>
        </div>
        <div class="status-text">
          <div class="main-status" id="main-status">æ¯”è³½é–‹å§‹</div>
          <div class="sub-status" id="sub-status">è«‹é›™æ–¹é¸æ“‡å¡ç‰Œæˆ–ç›´æ¥æŠ•çƒ</div>
        </div>
        <button class="play-btn" id="play-btn" onclick="startTurn()">æ“²éª°å­ (ROLL)</button>
      </div>
    </section>
  </main>
</div>

<script>
  /* --- 0. è³‡æ–™åº«: 20 å¼µå¡ç‰‡å®šç¾© (Updated for Exact Pair Rules) --- */
  const CARD_DB = {
    ATK: [
      { id: 'a1', name: 'å…¨åŠ›æ®æ“Š', icon: 'ğŸ’ª', desc: 'ä¸€å®‰â†’äºŒå®‰ï¼ŒäºŒå®‰â†’å…¨å£˜æ‰“' },
      { id: 'a2', name: 'é¸çƒçœ¼', icon: 'ğŸ‘ï¸', desc: 'å¦‚æœæ˜¯æ»¾åœ°å‡ºå±€ï¼Œå¯é‡éª°' },
      { id: 'a3', name: 'å¹¸é‹æ˜Ÿ', icon: 'ğŸŒŸ', desc: 'éª°åˆ°å‡ºå±€æ™‚ï¼Œæœ‰50%æ©Ÿç‡æ”¹ç‚ºå®‰æ‰“' },
      { id: 'a4', name: 'æ»¿è²«ç ²', icon: 'ğŸ†', desc: 'æ»¿å£˜æ™‚è‹¥å®‰æ‰“ï¼Œè¦–ç‚ºå…¨å£˜æ‰“' },
      { id: 'a5', name: 'çŸ­æ‰“æˆ°è¡“', icon: 'ğŸ', desc: 'çŠ§ç‰²æ‰“ï¼šæ¨é€²è·‘è€…ï¼Œæ‰“è€…å‡ºå±€' },
      { id: 'a6', name: 'ç›œå£˜æŒ‡ä»¤', icon: 'ğŸ‘Ÿ', desc: 'éš¨æ©Ÿä¸€åè·‘è€…å‰é€²ä¸€å€‹å£˜åŒ…' },
      { id: 'a7', name: 'æµæ˜Ÿæ‰“', icon: 'â˜„ï¸', desc: 'ç„¡è¦–å°æ‰‹æœ¬å›åˆé˜²ç¦¦å¡' },
      { id: 'a8', name: 'ç¥é æ¸¬', icon: 'ğŸ”®', desc: 'å¦‚æœæ˜¯ä¸‰æŒ¯ï¼Œè‡ªå‹•é‡éª°' },
      { id: 'a9', name: 'æ•™ç·´å–Šè©±', icon: 'ğŸ“£', desc: 'å°‡ä¸‰æŒ¯è½‰ç‚ºä¿é€' },
      { id: 'a10', name: 'å†ä¸€æ¬¡', icon: 'ğŸ”„', desc: 'ç„¡æ¢ä»¶é‡éª°é€™ä¸€æ¬¡çµæœ' }
    ],
    DEF: [
      { id: 'd1', name: 'å®ˆå‚™ä½ˆé™£', icon: 'ğŸ§¤', desc: 'ä¸€å£˜å®‰æ‰“ â†’ æ»¾åœ°å‡ºå±€' },
      { id: 'd2', name: 'éµå£é˜²å®ˆ', icon: 'ğŸ§±', desc: 'äºŒå£˜å®‰æ‰“ä»¥ä¸Š â†’ ä¸€å£˜å®‰æ‰“' },
      { id: 'd3', name: 'ç²¾æº–æ§çƒ', icon: 'ğŸ¯', desc: 'å°æ‰‹é‡éª°è¼ƒå¤§çš„é‚£é¡†éª°å­' },
      { id: 'd4', name: 'é›™æ®ºç¶²', icon: 'ğŸ•¸ï¸', desc: 'è‹¥æ»¾åœ°ä¸”ä¸€å£˜æœ‰äºº â†’ é›™æ®º' },
      { id: 'd5', name: 'é›·å°„è‚©', icon: 'âš¡', desc: 'è·‘è€…ç„¡æ³•å¤šæ¨é€²å£˜åŒ…' },
      { id: 'd6', name: 'è®Šé€Ÿçƒ', icon: 'ğŸŒ', desc: 'å°æ‰‹å¿…é ˆé‡éª°æ•¸å€¼è¼ƒå¤§çš„éª°å­' },
      { id: 'd7', name: 'å¨åš‡', icon: 'ğŸ˜ ', desc: 'ç„¡æ•ˆåŒ–å°æ‰‹çš„æ”»æ“Šå¡' },
      { id: 'd8', name: 'å£çƒé‡£é­š', icon: 'ğŸ£', desc: 'å°‡å››å£ä¿é€è½‰ç‚ºå£çƒ' },
      { id: 'd9', name: 'å…¨å£˜æ‰“ç‰†', icon: 'ğŸš§', desc: 'å…¨å£˜æ‰“ â†’ äºŒå£˜å®‰æ‰“' },
      { id: 'd10', name: 'å¹²æ“¾æˆ°è¡“', icon: 'ğŸº', desc: 'å¼·åˆ¶å°æ‰‹é‡éª°æ•¸å€¼è¼ƒå°çš„éª°å­' }
    ]
  };

  /* --- 1. å…¨åŸŸç‹€æ…‹ --- */
  let appState = {
    p1Color: '#d32f2f',
    p2Color: '#1976d2',
    p1Roll: 0,
    p2Roll: 0,
    visTeam: 'P1', 
    homeTeam: 'P2',
    visHand: [],
    homeHand: [],
    phase: 'PLANNING',
    runners: [false, false, false], 
    outs: 0,
    balls: 0,
    strikes: 0,
    inning: 1,
    isTop: true, 
    score: { vis: 0, home: 0 },
    selectedAtk: null,
    selectedDef: null,
    visCardsUsed: [], 
    homeCardsUsed: [] 
  };

  const COLORS = ['#d32f2f', '#1976d2', '#388e3c', '#fbc02d', '#7b1fa2', '#e64a19', '#5d4037', '#455a64'];
  const POSITIONS = {
    home:    { top: '79.7%', left: '50%' },
    first:   { top: '50%',   left: '79.7%' },
    second:  { top: '20.3%', left: '50%' },
    third:   { top: '50%',   left: '20.3%' },
    pitcher: { top: '50%',   left: '50%' },
    outfieldLeft:  { top: '15%', left: '20%' },
    outfieldRight: { top: '15%', left: '80%' },
    infield:       { top: '35%', left: '65%' }
  };
  
  // --- æ ¸å¿ƒï¼š21ç¨®çµ„åˆè¡¨ (åƒè€ƒåœ–ç‰‡) ---
  const RESULT_MAP = [
    // Column 1
    { d1:1, d2:1, res:'Home Run' },
    { d1:1, d2:2, res:'Double' },
    { d1:1, d2:3, res:'Fly Out' },
    { d1:1, d2:4, res:'Walk' },
    { d1:1, d2:5, res:'Pop Out' },
    { d1:1, d2:6, res:'Single' },
    { d1:2, d2:2, res:'Double Play' },
    // Column 2
    { d1:2, d2:3, res:'Ground Out' },
    { d1:2, d2:4, res:'Strike Out' },
    { d1:2, d2:5, res:'Single' },
    { d1:2, d2:6, res:'Strike Out' },
    { d1:3, d2:3, res:'Walk' },
    { d1:3, d2:4, res:'Triple' },
    { d1:3, d2:5, res:'Ground Out' },
    // Column 3
    { d1:3, d2:6, res:'Fly Out' },
    { d1:4, d2:4, res:'Walk' },
    { d1:4, d2:5, res:'Pop Out' },
    { d1:4, d2:6, res:'Strike Out' },
    { d1:5, d2:5, res:'Double' },
    { d1:5, d2:6, res:'Sacrifice Fly' },
    { d1:6, d2:6, res:'Home Run' }
  ];

  /* --- Utils --- */
  function getOutcomeByDice(v1, v2) {
    const min = Math.min(v1, v2);
    const max = Math.max(v1, v2);
    const found = RESULT_MAP.find(r => r.d1 === min && r.d2 === max);
    return found ? found.res : 'Out';
  }

  function renderMachineGrid() {
    const grid = document.getElementById('machine-grid');
    grid.innerHTML = '';
    RESULT_MAP.forEach((item, idx) => {
      const el = document.createElement('div');
      el.className = 'res-cell';
      el.id = `mc-${item.d1}-${item.d2}`;
      el.innerHTML = `
        <span class="d-pair">${item.d1}-${item.d2}</span>
        <span class="d-out">${item.res}</span>
      `;
      grid.appendChild(el);
    });
  }

  function init() {
    renderColorPickers();
    renderMachineGrid();
  }

  /* --- Setup Logic --- */
  function showGallery() {
    const grid = document.getElementById('gallery-content');
    grid.innerHTML = '';
    CARD_DB.ATK.forEach(c => renderCardPreview(c, 'atk', grid));
    CARD_DB.DEF.forEach(c => renderCardPreview(c, 'def', grid));
    document.getElementById('gallery-screen').classList.remove('hidden');
  }
  function renderCardPreview(c, type, container) {
    const el = document.createElement('div');
    el.className = `card-preview ${type}`;
    el.innerHTML = `<div style="font-size:2rem">${c.icon}</div><div style="font-weight:bold; font-size:0.9rem">${c.name}</div><div style="font-size:0.7rem; color:#aaa">${c.desc}</div>`;
    container.appendChild(el);
  }
  function closeGallery() { document.getElementById('gallery-screen').classList.add('hidden'); }
  function goToSetup() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('setup-screen').classList.remove('hidden'); }
  function renderColorPickers() {
    const p1c = document.getElementById('p1-colors');
    const p2c = document.getElementById('p2-colors');
    p1c.innerHTML = ''; p2c.innerHTML = '';
    COLORS.forEach(c => {
      let d1 = document.createElement('div'); d1.className = `color-option ${c===appState.p1Color?'selected':''}`; d1.style.backgroundColor=c;
      d1.onclick=()=>{appState.p1Color=c; renderColorPickers();}
      p1c.appendChild(d1);
      let d2 = document.createElement('div'); d2.className = `color-option ${c===appState.p2Color?'selected':''}`; d2.style.backgroundColor=c;
      d2.onclick=()=>{appState.p2Color=c; renderColorPickers();}
      p2c.appendChild(d2);
    });
  }
  function goToInitiative() { document.getElementById('step-color').style.display='none'; document.getElementById('step-initiative').style.display='block'; }
  function rollInitiative(player) {
    const val = Math.floor(Math.random()*100)+1;
    if(player===1) { appState.p1Roll=val; document.getElementById('p1-roll').innerText=val; document.getElementById('btn-roll-p1').disabled=true; }
    else { appState.p2Roll=val; document.getElementById('p2-roll').innerText=val; document.getElementById('btn-roll-p2').disabled=true; }
    if(appState.p1Roll>0 && appState.p2Roll>0) {
      const res = document.getElementById('initiative-result');
      if(appState.p1Roll > appState.p2Roll) { res.innerText="P1 ä¸»éšŠ (å¾Œæ”»)"; appState.homeTeam='P1'; appState.visTeam='P2'; }
      else { res.innerText="P2 ä¸»éšŠ (å¾Œæ”»)"; appState.homeTeam='P2'; appState.visTeam='P1'; }
      document.getElementById('btn-go-draw').style.display='block';
    }
  }
  function goToDraw() { document.getElementById('step-initiative').style.display='none'; document.getElementById('step-draw').style.display='block'; }
  function drawCardsAnimation() {
    const draw = (arr, count) => [...arr].sort(()=>0.5-Math.random()).slice(0,count);
    const p1Hand = [...draw(CARD_DB.ATK,3), ...draw(CARD_DB.DEF,3)];
    const p2Hand = [...draw(CARD_DB.ATK,3), ...draw(CARD_DB.DEF,3)];
    if(appState.visTeam==='P1') { appState.visHand=p1Hand; appState.homeHand=p2Hand; }
    else { appState.visHand=p2Hand; appState.homeHand=p1Hand; }
    const renderList = (hand, elId) => document.getElementById(elId).innerHTML = hand.map(c=>`[${c.icon}${c.name}]`).join(' ');
    renderList(appState.visHand, 'vis-hand-list'); renderList(appState.homeHand, 'home-hand-list');
    document.getElementById('draw-result-area').style.display='block';
  }
  function startGameFromSetup() {
    document.documentElement.style.setProperty('--vis-color', appState.visTeam==='P1'?appState.p1Color:appState.p2Color);
    document.documentElement.style.setProperty('--home-color', appState.homeTeam==='P1'?appState.p1Color:appState.p2Color);
    updateHandUI('vis'); updateHandUI('home');
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('main-game').classList.remove('blur');
  }

  /* --- Game Loop --- */
  const ball = document.getElementById('ball');
  const d1 = document.getElementById('d1');
  const d2 = document.getElementById('d2');
  const statusMain = document.getElementById('main-status');
  const statusSub = document.getElementById('sub-status');
  const btn = document.getElementById('play-btn');

  function updateHandUI(side) {
    const isVis = side === 'vis';
    const hand = isVis ? appState.visHand : appState.homeHand;
    const usedList = isVis ? appState.visCardsUsed : appState.homeCardsUsed;
    const container = document.getElementById(isVis?'vis-cards-area':'home-cards-area');
    container.innerHTML = '';
    const currentAtkTeam = appState.isTop ? 'vis' : 'home';
    const showAtkCards = (side === currentAtkTeam);

    hand.forEach(card => {
      const isAtkCard = CARD_DB.ATK.some(c=>c.id===card.id);
      if((showAtkCards && isAtkCard) || (!showAtkCards && !isAtkCard)) {
        const isUsed = usedList.includes(card.id);
        const el = document.createElement('div');
        el.className = `card ${isUsed?'used disabled':''}`;
        el.onclick = ()=>selectCard(side, card, el);
        el.innerHTML = `<div class="card-icon">${card.icon}</div><div class="card-info"><div class="card-title">${card.name}</div><div class="card-effect">${card.desc}</div></div>`;
        container.appendChild(el);
      }
    });
  }

  function selectCard(side, card, el) {
    if(appState.phase !== 'PLANNING') return;
    const isAtk = CARD_DB.ATK.some(c=>c.id===card.id);
    const targetSlot = isAtk ? 'atk' : 'def';
    el.parentElement.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
    if((isAtk && appState.selectedAtk?.id===card.id) || (!isAtk && appState.selectedDef?.id===card.id)) {
      if(isAtk) appState.selectedAtk=null; else appState.selectedDef=null;
      updateSlot(targetSlot, null);
    } else {
      el.classList.add('selected');
      if(isAtk) appState.selectedAtk=card; else appState.selectedDef=card;
      updateSlot(targetSlot, card);
    }
  }

  function updateSlot(type, card) {
    const box = document.getElementById(`slot-${type}`);
    const icon = document.getElementById(`icon-${type}`);
    const name = document.getElementById(`name-${type}`);
    if(card) { box.classList.add('filled', `${type}-filled`); icon.innerText=card.icon; name.innerText=card.name; }
    else { box.className='slot-box'; icon.innerText=type==='atk'?'âš”ï¸':'ğŸ›¡ï¸'; name.innerText='ç­‰å¾…é¸æ“‡'; }
  }

  function startTurn() {
    if(appState.phase === 'RESOLVED') { resetTurn(); return; }
    appState.phase = 'ROLLING'; btn.disabled = true;
    document.getElementById('roll-overlay').classList.remove('hidden');
    const md1 = document.getElementById('m-d1'); const md2 = document.getElementById('m-d2');
    md1.classList.add('rolling'); md2.classList.add('rolling');
    md1.innerText="?"; md2.innerText="?";
    
    setTimeout(() => {
      const v1 = Math.floor(Math.random()*6)+1;
      const v2 = Math.floor(Math.random()*6)+1;
      md1.innerText=v1; md2.innerText=v2;
      md1.classList.remove('rolling'); md2.classList.remove('rolling');
      d1.innerText=v1; d2.innerText=v2;
      runMachineAnimation(v1, v2);
    }, 500);
  }

  function runMachineAnimation(v1, v2) {
    const min = Math.min(v1, v2);
    const max = Math.max(v1, v2);
    const targetId = `mc-${min}-${max}`;
    
    // Create random sequence of IDs for effect
    let sequence = [];
    for(let i=0; i<15; i++) {
        const rand = RESULT_MAP[Math.floor(Math.random()*RESULT_MAP.length)];
        sequence.push(`mc-${rand.d1}-${rand.d2}`);
    }
    sequence.push(targetId); sequence.push(targetId); // End on target
    
    let currentIdx = 0; let speed = 50;
    
    function step() {
      document.querySelectorAll('.res-cell').forEach(b=>b.classList.remove('active'));
      const cid = sequence[currentIdx];
      const el = document.getElementById(cid);
      if(el) el.classList.add('active');
      
      if(currentIdx >= sequence.length -1) {
        setTimeout(()=>{
           document.getElementById('roll-overlay').classList.add('hidden');
           resolveResult(v1, v2);
        }, 1500);
        return;
      }
      currentIdx++;
      speed += 15; // slow down
      setTimeout(step, speed);
    }
    step();
  }

  function resolveResult(v1, v2) {
    appState.phase = 'ANIMATING';
    let type = getOutcomeByDice(v1, v2);
    let msg = `åŸå§‹çµæœ: ${type}`;

    // --- ATK Logic ---
    if(appState.selectedAtk) {
        const id = appState.selectedAtk.id;
        if(appState.isTop) appState.visCardsUsed.push(id); else appState.homeCardsUsed.push(id);
        if(id==='a1' && type==='Single') { type='Double'; msg='å…¨åŠ›æ®æ“Š!'; }
        if(id==='a1' && type==='Double') { type='Home Run'; msg='å…¨å£˜æ‰“!'; }
        if(id==='a8' && (type.includes('Strike Out'))) { msg='ç¥é æ¸¬é‡éª°!'; type='Single'; /* Simulating reroll success */ }
        if(id==='a9' && (type.includes('Strike Out'))) { type='Walk'; msg='é¸åˆ°ä¿é€!'; }
        if(id==='a2' && (type.includes('Ground Out'))) { type='Single'; msg='é¸çƒçœ¼é‡éª°æˆåŠŸ!'; }
    }

    // --- DEF Logic ---
    if(appState.selectedDef) {
        const id = appState.selectedDef.id;
        if(!appState.isTop) appState.visCardsUsed.push(id); else appState.homeCardsUsed.push(id);
        if(appState.selectedAtk?.id === 'a7') { msg += ' (é˜²ç¦¦ç„¡æ•ˆ)'; }
        else {
           if(id==='d1' && type==='Single') { type='Ground Out'; msg='å®ˆå‚™ä½ˆé™£!'; }
           if(id==='d2' && (type==='Double'||type==='Triple'||type==='Home Run')) { type='Single'; msg='éµå£é˜²å®ˆ!'; }
           if(id==='d9' && type==='Home Run') { type='Double'; msg='å…¨å£˜æ‰“ç‰†æ“‹ä¸‹!'; }
        }
    }

    statusMain.innerText = type;
    statusSub.innerText = msg;
    performFieldAnimation(type);
    setTimeout(() => { handleGameLogic(type); endTurn(); }, 2000);
  }

  function handleGameLogic(type) {
    // Simplified Logic mapping complex outcomes to simple runner logic
    // Treat 'Fly Out', 'Pop Out', 'Strike Out' as Outs.
    // 'Ground Out' -> Out (ignore force play complexity for now)
    // 'Double Play' -> 2 Outs
    // 'Sacrifice Fly' -> Out but runner scores from 3rd
    
    if(['Single','Walk'].includes(type)) {
       if(appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
       appState.runners[2]=appState.runners[1]; appState.runners[1]=appState.runners[0]; appState.runners[0]=true;
    } else if(type==='Double') {
       if(appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
       if(appState.runners[1]) appState.score[appState.isTop?'vis':'home']++;
       appState.runners[2]=appState.runners[0]; appState.runners[1]=true; appState.runners[0]=false;
    } else if(type==='Triple') {
       if(appState.runners[2]) appState.score[appState.isTop?'vis':'home']++;
       if(appState.runners[1]) appState.score[appState.isTop?'vis':'home']++;
       if(appState.runners[0]) appState.score[appState.isTop?'vis':'home']++;
       appState.runners = [false, false, true];
    } else if(type==='Home Run') {
       let runs = 1 + (appState.runners[0]?1:0) + (appState.runners[1]?1:0) + (appState.runners[2]?1:0);
       appState.score[appState.isTop?'vis':'home'] += runs;
       appState.runners = [false,false,false];
    } else if(type==='Sacrifice Fly') {
       appState.outs++;
       if(appState.runners[2] && appState.outs < 3) {
           appState.score[appState.isTop?'vis':'home']++;
           appState.runners[2] = false;
       }
    } else if(type==='Double Play') {
       appState.outs++;
       if(appState.outs < 3) appState.outs++; // Add another out
       // Clear lead runner for simplicity
       if(appState.runners[0]) appState.runners[0] = false;
    } else {
       // All other Outs
       appState.outs++;
    }
    
    updateScoreboard();
    updateRunnersDisplay();
  }

  function updateScoreboard() {
      document.getElementById('score-vis-total').innerText = appState.score.vis;
      document.getElementById('score-home-total').innerText = appState.score.home;
      for(let i=1; i<=2; i++) document.getElementById(`light-o${i}`).className = `light ${i<=appState.outs ? 'on-red':''}`;
      
      if(appState.outs >= 3) {
          appState.outs = 0; appState.runners = [false,false,false]; appState.isTop = !appState.isTop;
          if(appState.isTop) appState.inning++;
          statusMain.innerText = "æ”»å®ˆäº¤æ›";
          updateHandUI('vis'); updateHandUI('home');
      }
  }

  /* --- Animation Utils --- */
  function resetBallPosition(posName) { ball.style.top=POSITIONS[posName].top; ball.style.left=POSITIONS[posName].left; ball.style.opacity=1; }
  function moveBallTo(posName, d=500) { ball.style.transition=`top ${d}ms ease-out, left ${d}ms ease-out`; void ball.offsetWidth; ball.style.top=POSITIONS[posName].top; ball.style.left=POSITIONS[posName].left; }
  
  function performFieldAnimation(type) {
    if(['Strike Out','Fly Out','Pop Out','Double Play'].includes(type)) ball.style.opacity=0;
    else if(['Ground Out'].includes(type)) moveBallTo('infield', 400);
    else if(['Single','Walk','Sacrifice Fly'].includes(type)) moveBallTo('outfieldRight', 600);
    else if(['Double','Triple'].includes(type)) moveBallTo('outfieldLeft', 800);
    else if(type==='Home Run') {
      ball.style.transition = "top 1s ease-in, left 1s linear, transform 1s ease-in";
      ball.style.top="-10%"; ball.style.left="20%"; ball.style.transform="scale(0.5)";
    }
  }
  function updateRunnersDisplay() {
    const bases = ['first', 'second', 'third'];
    for(let i=0; i<3; i++) {
      const el = document.getElementById(`runner-${i+1}`);
      el.className = `runner-dot ${appState.isTop?'':'home-team'} ${appState.runners[i]?'active':''}`;
      if(appState.runners[i]) { el.style.top=POSITIONS[bases[i]].top; el.style.left=POSITIONS[bases[i]].left; }
    }
  }
  function endTurn() { appState.phase='RESOLVED'; btn.disabled=false; btn.innerText="ä¸‹ä¸€æ‰“å¸­"; }
  function resetTurn() {
    appState.phase='PLANNING'; appState.selectedAtk=null; appState.selectedDef=null;
    updateSlot('atk',null); updateSlot('def',null);
    updateHandUI('vis'); updateHandUI('home');
    ball.style.opacity=0; ball.style.transform="none";
    d1.innerText="?"; d2.innerText="?"; statusMain.innerText="è«‹é¸æ“‡æˆ°è¡“å¡"; btn.innerText="æ“²éª°å­ (ROLL)";
  }

  init();
</script>
</body>
</html>
